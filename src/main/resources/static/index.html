<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>MyCommerce</title>
    <link rel="stylesheet" href="/css/style.css" />
</head>
<body>

<div class="container unauthenticated">
    <h1>MyCommerce</h1>
    <a href="/oauth2/authorization/github" class="btn">GitHub으로 로그인</a>
</div>

<div class="container authenticated" style="display:none">
    <h1>환영합니다!</h1>
    <div class="user-info">
        <p><strong id="user"></strong>님</p>
        <p><small id="email"></small></p>
    </div>
    <button type="button" onclick="logout()" class="btn" style="margin-top: 20px;">로그아웃</button>
</div>

<script>
    // ===== UI 토글 유틸 =====
    function showAuth(data) {
        document.querySelector('.unauthenticated').style.display = 'none';
        document.querySelector('.authenticated').style.display = 'block';
        document.getElementById('user').textContent = data?.name || '사용자';
        document.getElementById('email').textContent = data?.email || '';
    }
    function showUnAuth() {
        document.querySelector('.authenticated').style.display = 'none';
        document.querySelector('.unauthenticated').style.display = 'block';
    }

    // ===== 초기 로드: CSRF 발급 → 사용자 정보 조회 =====
    document.addEventListener('DOMContentLoaded', function () {
        // 1) CSRF 토큰 발급 트리거
        fetch('/api/csrf', { method: 'GET', credentials: 'include' });

        // 2) 로그인한 사용자 정보 조회
        fetch('/api/users/me')
            .then(response => {
                if (response.ok) return response.json();
                throw new Error('Not authenticated');
            })
            .then(data => showAuth(data))
            .catch(() => showUnAuth());
    });

    // ===== 로그아웃  =====
    function logout() {
        const token = getCookie('XSRF-TOKEN');

        console.log('=== 로그아웃 디버깅 ===');
        console.log('CSRF 토큰:', token);
        console.log('모든 쿠키:', document.cookie);

        if (!token) {
            alert('CSRF 토큰이 없습니다!');
            return;
        }

        fetch('/logout', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'X-XSRF-TOKEN': token,
                'Content-Type': 'application/x-www-form-urlencoded'
            }
        })
            .then(response => {
                console.log('응답 상태:', response.status);
                console.log('응답 URL:', response.url);

                if (response.ok || response.redirected) {
                    // 로그아웃 성공 -> 페이지 새로고침
                    window.location.href = '/';
                } else if (response.status === 403) {
                    alert('로그아웃 실패: 권한 없음');
                } else {
                    alert('로그아웃 실패: ' + response.status);
                }
            })
            .catch(error => {
                console.error('로그아웃 에러:', error);
                alert('로그아웃 실패: ' + error.message);
            });
    }

    // ===== 쿠키 읽기  =====
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
</script>

</body>
</html>
